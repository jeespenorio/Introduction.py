#=====================================================================================================================
#Import Libraries
#=====================================================================================================================
import streamlit as st
import pandas as pd

#=====================================================================================================================
# Upload the CSV file
#=====================================================================================================================
uploaded_file = st.file_uploader("Upload a CSV file", type=["csv"])

if uploaded_file is not None:
    #=====================================================================================================================
    # Read the uploaded CSV file
    #=====================================================================================================================
    Table1 = pd.read_csv(uploaded_file, low_memory=False)

    #=====================================================================================================================
    # Rename columns
    #=====================================================================================================================
    Table1.rename(columns={
        'Customer name (customer)': 'Customer',
        'Fee (charge)': 'Fee',
        'Quantity (charge)': 'Quantity',
        'Total (charge)': 'Total',
    }, inplace=True)

    #=====================================================================================================================
    # Check for and count null values in 'Quantity' and 'Total' columns
    #=====================================================================================================================
    null_quantity_count = Table1['Quantity'].isnull().sum()
    null_total_count = Table1['Total'].isnull().sum()

    #=====================================================================================================================
    # Filter out rows with null values in 'Quantity' and 'Total' columns
    #=====================================================================================================================
    Table1 = Table1.dropna(subset=['Quantity', 'Total'])

    #=====================================================================================================================
    # Convert object to float64
    #=====================================================================================================================
    Table1['Quantity'] = pd.to_numeric(Table1['Quantity'], errors='coerce')
    Table1['Total'] = pd.to_numeric(Table1['Total'], errors='coerce')

    #=====================================================================================================================
    # Recreate the pivot table without the 'Description' column and compute the grand total for all customers
    #=====================================================================================================================
    pivot_table = Table1.pivot_table(index='Customer',
                                     values=['Quantity', 'Total'],
                                     aggfunc='sum')

    #=====================================================================================================================
    # Compute the grand total of 'Quantity' and 'Total'
    #=====================================================================================================================
    grand_total = pivot_table.sum(numeric_only=True).to_frame().T
    grand_total.index = ['Grand Total']
    
    #=====================================================================================================================
    # Reset the index for the grand_total Dataframe
    #=====================================================================================================================

    grand_total = grand_total.rename({'Customer': 'Grand Total'})

    #=====================================================================================================================
    # Reset the index to make it look cleaner
    #=====================================================================================================================
    pivot_table.reset_index(inplace=True)

    #=====================================================================================================================
    # Merge the pivot table and grand total
    #=====================================================================================================================
    merged_table = pd.concat([pivot_table, grand_total], axis=0)

    #=====================================================================================================================
    # Format the 'Total' column as a dollar amount
    #=====================================================================================================================
    merged_table['Total'] = merged_table['Total'].apply(lambda x: "${:,.2f}".format(x))

    #=====================================================================================================================
    # Replace "None" with "Grand Total" in the index
    #=====================================================================================================================
    merged_table.index = ['Grand Total' if idx == None else idx for idx in merged_table.index]
    #=====================================================================================================================
    # Display the grand total
    #=====================================================================================================================
    st.subheader("Grand Total:")
    st.dataframe(merged_table)